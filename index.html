<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Share Global Earnings Monitor</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151f32', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ------------------------------------------------------------------
        // CONFIGURATION & CONSTANTS
        // ------------------------------------------------------------------
        
        // Scoring Weights (Configurable)
        const LEADER_WEIGHTS = {
            supplyChain: 30, // Entry into overseas top-tier supply chain
            scale: 20,       // Revenue scale and stability
            margin: 20,      // Gross margin value & trend
            overseas: 15,    // Overseas revenue share
            visibility: 15   // Order visibility
        };

        const GROWTH_WEIGHTS = {
            cagr: 30,        // 3-Year Revenue CAGR
            orders: 25,      // Order/Customer growth
            marginPot: 20,   // Margin potential
            valuation: 15,   // Reasonable valuation
            risk: -20        // Concentration/Geopolitical risk (Negative score)
        };

        // Profit Signal Thresholds
        const SIGNALS = {
            GREEN: 'green',   // Accelerating
            YELLOW: 'yellow', // Stable
            RED: 'red'        // Under Pressure
        };

        // ------------------------------------------------------------------
        // LOGIC HELPERS
        // ------------------------------------------------------------------

        /**
         * Determines the Profit Signal based on metrics.
         * Logic:
         * Green: OrderBook UP && Margin UP && Overseas >= 50%
         * Yellow: (OrderBook UP || Margin UP) && Overseas >= 30%
         * Red: Else (or specific negative trends)
         */
        const determineSignal = (metrics) => {
            const orderUp = metrics.order_book_trend === 'up';
            const marginUp = metrics.gross_margin >= metrics.gross_margin_prev;
            const overseasHigh = metrics.overseas_share >= 0.5;
            const overseasMed = metrics.overseas_share >= 0.3;

            if (orderUp && marginUp && overseasHigh) return SIGNALS.GREEN;
            if ((orderUp || marginUp) && overseasMed) return SIGNALS.YELLOW;
            return SIGNALS.RED;
        };

        /**
         * Calculates a simple score for display purposes if not provided in JSON.
         * (In a real app, this might parse the stock object properties against weights)
         */
        const calculateScore = (breakdown) => {
            if (!breakdown) return 0;
            return Object.values(breakdown).reduce((a, b) => a + b, 0);
        };

        // ------------------------------------------------------------------
        // UI COMPONENTS
        // ------------------------------------------------------------------

        const Badge = ({ children, className }) => (
            <span className={`px-2 py-0.5 rounded text-xs font-semibold ${className}`}>
                {children}
            </span>
        );

        const SignalIndicator = ({ signal }) => {
            const config = {
                [SIGNALS.GREEN]: { color: 'bg-emerald-500', text: '盈利加速', textCol: 'text-emerald-400', glow: 'shadow-[0_0_10px_rgba(16,185,129,0.5)]' },
                [SIGNALS.YELLOW]: { color: 'bg-amber-500', text: '盈利稳定', textCol: 'text-amber-400', glow: '' },
                [SIGNALS.RED]: { color: 'bg-rose-500', text: '盈利承压', textCol: 'text-rose-400', glow: '' },
            }[signal] || { color: 'bg-slate-500', text: '未知', textCol: 'text-slate-400' };

            return (
                <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-full ${config.color} ${config.glow}`}></div>
                    <span className={`text-sm font-medium ${config.textCol}`}>{config.text}</span>
                </div>
            );
        };

        const StockTable = ({ type, stocks }) => {
            if (!stocks || stocks.length === 0) return null;
            const isLeader = type === 'leader';

            return (
                <div className="flex-1 min-w-[300px]">
                    <h4 className={`text-xs uppercase tracking-wider font-bold mb-3 flex items-center gap-2 ${isLeader ? 'text-indigo-400' : 'text-teal-400'}`}>
                        {isLeader ? <i data-lucide="crown" className="w-4 h-4" /> : <i data-lucide="trending-up" className="w-4 h-4" />}
                        {isLeader ? '龙头 (Leaders)' : '成长候选 (Growth)'}
                    </h4>
                    <div className="space-y-3">
                        {stocks.map((stock, idx) => (
                            <div key={idx} className="bg-slate-800/50 p-3 rounded border border-slate-700/50 hover:border-slate-600 transition-colors">
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-slate-200">{stock.name}</span>
                                            <span className="text-xs text-slate-500 font-mono">{stock.code}</span>
                                        </div>
                                        {/* Score Display */}
                                        <div className="text-xs text-slate-400 mt-1">
                                            Score: <span className="font-mono text-slate-300">{calculateScore(stock.score_breakdown)}</span>
                                        </div>
                                    </div>
                                    {isLeader ? (
                                        <div className="text-right">
                                            <div className="text-xs text-slate-400">海外占比</div>
                                            <div className="font-mono text-sm text-slate-200">{(stock.overseas_share * 100).toFixed(0)}%</div>
                                        </div>
                                    ) : (
                                        <div className="text-right">
                                            <div className="text-xs text-slate-400">3Y CAGR</div>
                                            <div className="font-mono text-sm text-slate-200">{(stock.revenue_cagr_3y * 100).toFixed(0)}%</div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Metrics Grid */}
                                <div className="grid grid-cols-2 gap-2 text-xs mb-2">
                                    {isLeader ? (
                                        <>
                                            <div className="text-slate-400">Q4营收: <span className={stock.revenue_q4yoy > 0 ? 'text-emerald-400' : 'text-rose-400'}>{(stock.revenue_q4yoy * 100).toFixed(1)}%</span></div>
                                            <div className="text-slate-400">毛利: <span className="text-slate-300">{(stock.gross_margin * 100).toFixed(1)}%</span></div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="text-slate-400">订单增: <span className="text-emerald-400">{(stock.order_growth * 100).toFixed(1)}%</span></div>
                                        </>
                                    )}
                                </div>
                                
                                <div className={`text-xs p-1.5 rounded ${isLeader ? 'bg-indigo-950/30 text-indigo-200' : 'bg-teal-950/30 text-teal-200'}`}>
                                    {isLeader ? stock.note : `⚠️ ${stock.risk}`}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SectorCard = ({ sector }) => {
            const computedSignal = determineSignal(sector.metrics);

            // Border color based on signal
            const borderColor = {
                [SIGNALS.GREEN]: 'border-emerald-500',
                [SIGNALS.YELLOW]: 'border-amber-500',
                [SIGNALS.RED]: 'border-rose-500',
            }[computedSignal];

            return (
                <div className={`bg-slate-850 rounded-lg p-5 border-l-4 ${borderColor} shadow-lg mb-6`}>
                    {/* Header */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <div className="flex items-center gap-3 mb-2">
                                <h2 className="text-xl font-bold text-white">{sector.name}</h2>
                                <Badge className="bg-slate-700 text-slate-300">P{sector.priority}</Badge>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {sector.tags.map(tag => (
                                    <Badge key={tag} className="bg-blue-900/40 text-blue-300 border border-blue-800/50">{tag}</Badge>
                                ))}
                            </div>
                        </div>
                        <div className="flex items-center gap-4 bg-slate-900/50 p-3 rounded-lg border border-slate-800">
                            <SignalIndicator signal={computedSignal} />
                            <div className="h-8 w-px bg-slate-700 mx-2"></div>
                            <div className="text-right">
                                <div className="text-xs text-slate-500 uppercase">Trend</div>
                                <div className={`text-sm font-bold flex items-center justify-end gap-1 ${sector.trend === 'up' ? 'text-emerald-400' : 'text-slate-300'}`}>
                                    {sector.trend.toUpperCase()} 
                                    {sector.trend === 'up' && <i data-lucide="arrow-up-right" className="w-3 h-3" />}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Sector Metrics */}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 pb-6 border-b border-slate-700/50">
                        <div>
                            <div className="text-xs text-slate-500 mb-1">Shipment</div>
                            <div className="text-sm font-mono text-white">{sector.metrics.shipment}</div>
                        </div>
                        <div>
                            <div className="text-xs text-slate-500 mb-1">ASP</div>
                            <div className="text-sm font-mono text-white">{sector.metrics.ASP}</div>
                        </div>
                        <div>
                            <div className="text-xs text-slate-500 mb-1">Gross Margin</div>
                            <div className="text-sm font-mono flex items-center gap-1">
                                {(sector.metrics.gross_margin * 100).toFixed(1)}%
                                {sector.metrics.gross_margin > sector.metrics.gross_margin_prev ? 
                                    <span className="text-emerald-500 text-[10px]">▲</span> : 
                                    <span className="text-rose-500 text-[10px]">▼</span>
                                }
                            </div>
                        </div>
                        <div>
                            <div className="text-xs text-slate-500 mb-1">Overseas Share</div>
                            <div className="text-sm font-mono text-white">{(sector.metrics.overseas_share * 100).toFixed(0)}%</div>
                        </div>
                        <div>
                            <div className="text-xs text-slate-500 mb-1">Order Trend</div>
                            <div className={`text-sm font-bold ${sector.metrics.order_book_trend === 'up' ? 'text-emerald-400' : 'text-amber-400'}`}>
                                {sector.metrics.order_book_trend.toUpperCase()}
                            </div>
                        </div>
                    </div>

                    {/* Stock Tables */}
                    <div className="flex flex-col lg:flex-row gap-6">
                        <StockTable type="leader" stocks={sector.leaders} />
                        <div className="hidden lg:block w-px bg-slate-700/50"></div>
                        <StockTable type="growth" stocks={sector.growth_candidates} />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState({ signal: 'all', sort: 'priority' });

            // Fetch Data
            useEffect(() => {
                // DATA FETCHING: Swap this URL with your real API in the future
                fetch('./data.json')
                    .then(res => {
                        if(!res.ok) throw new Error("Failed to load data");
                        return res.json();
                    })
                    .then(jsonData => {
                        setData(jsonData);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error("Error loading data:", err);
                        // Fallback/Empty state could go here
                        setLoading(false);
                    });
            }, []);

            // Re-run icons after render
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // Filter & Sort Logic
            const processedData = useMemo(() => {
                let result = [...data];

                // Filter
                if (filter.signal !== 'all') {
                    result = result.filter(item => determineSignal(item.metrics) === filter.signal);
                }

                // Sort
                result.sort((a, b) => {
                    if (filter.sort === 'priority') return a.priority - b.priority;
                    if (filter.sort === 'overseas') return b.metrics.overseas_share - a.metrics.overseas_share;
                    if (filter.sort === 'margin') return b.metrics.gross_margin - a.metrics.gross_margin;
                    return 0;
                });

                return result;
            }, [data, filter]);

            // Export to CSV
            const handleExport = () => {
                const headers = ["Sector", "Priority", "Signal", "Type", "Code", "Name", "Score", "OverseasShare", "Note/Risk"];
                const rows = [];

                data.forEach(sector => {
                    const signal = determineSignal(sector.metrics);
                    // Add Leaders
                    sector.leaders?.forEach(l => {
                        rows.push([sector.name, sector.priority, signal, "Leader", l.code, l.name, calculateScore(l.score_breakdown), l.overseas_share, l.note]);
                    });
                    // Add Growth
                    sector.growth_candidates?.forEach(g => {
                        rows.push([sector.name, sector.priority, signal, "Growth", g.code, g.name, calculateScore(g.score_breakdown), "-", g.risk]);
                    });
                });

                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.map(c => `"${c}"`).join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `a-share-monitor-${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500">Loading Market Data...</div>;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                                A-Share Global Monitor
                            </h1>
                            <p className="text-slate-400 text-sm mt-1">
                                Tracking earnings-driven sectors & global supply chain leaders.
                            </p>
                        </div>
                        <div className="flex gap-3">
                            <button 
                                onClick={handleExport}
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-700 transition-all text-sm font-medium">
                                <i data-lucide="download" className="w-4 h-4" /> Export CSV
                            </button>
                            <a 
                                href="./data.json" target="_blank"
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white px-4 py-2 rounded-lg border border-slate-700 transition-all text-sm font-medium">
                                <i data-lucide="file-json" className="w-4 h-4" /> JSON
                            </a>
                        </div>
                    </header>

                    {/* Controls */}
                    <div className="flex flex-wrap items-center gap-4 mb-8 bg-slate-900/80 p-4 sticky top-0 z-10 backdrop-blur border-b border-slate-800">
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-slate-500 uppercase">Sort By</span>
                            <select 
                                value={filter.sort}
                                onChange={(e) => setFilter({...filter, sort: e.target.value})}
                                className="bg-slate-800 border border-slate-700 text-slate-200 text-sm rounded px-3 py-1.5 focus:outline-none focus:border-blue-500">
                                <option value="priority">Priority</option>
                                <option value="overseas">Overseas Share</option>
                                <option value="margin">Gross Margin</option>
                            </select>
                        </div>

                        <div className="flex items-center gap-2 ml-auto">
                            <span className="text-xs font-bold text-slate-500 uppercase mr-2">Filter Signal</span>
                            {[
                                { val: 'all', label: 'All' },
                                { val: SIGNALS.GREEN, label: 'Accelerating', col: 'text-emerald-400' },
                                { val: SIGNALS.YELLOW, label: 'Stable', col: 'text-amber-400' },
                                { val: SIGNALS.RED, label: 'Pressure', col: 'text-rose-400' }
                            ].map(opt => (
                                <button
                                    key={opt.val}
                                    onClick={() => setFilter({...filter, signal: opt.val})}
                                    className={`px-3 py-1 rounded text-sm transition-all border ${
                                        filter.signal === opt.val 
                                            ? 'bg-slate-700 border-slate-500 text-white' 
                                            : 'bg-transparent border-transparent text-slate-500 hover:text-slate-300'
                                    } ${opt.col || ''}`}
                                >
                                    {opt.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* List */}
                    <div className="grid grid-cols-1 gap-6">
                        {processedData.map(sector => (
                            <SectorCard key={sector.id} sector={sector} />
                        ))}
                    </div>

                    {/* Footer / Instructions */}
                    <footer className="mt-12 pt-8 border-t border-slate-800 text-center text-slate-600 text-xs">
                        <p>A-Share Global Monitor • Data Source: Local JSON • Update Frequency: Weekly</p>
                        <p className="mt-2">Deploy to GitHub Pages by pushing index.html & data.json to root.</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>